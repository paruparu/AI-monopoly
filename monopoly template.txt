<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»ãƒ¢ãƒãƒãƒªãƒ¼ (CPUäº¤æ¸‰æ©Ÿèƒ½ä»˜ã)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'M PLUS Rounded 1c', sans-serif; }
        .game-layout { display: flex; flex-direction: column; align-items: flex-start; gap: 20px; }
        @media (min-width: 1280px) { .game-layout { flex-direction: row; } }
        .board {
            display: grid;
            grid-template-columns: 100px repeat(9, minmax(60px, 1fr)) 100px;
            grid-template-rows: 100px repeat(9, minmax(60px, 1fr)) 100px;
            gap: 2px; width: 100%; max-width: 800px; background-color: #1a202c;
            border: 4px solid #1a202c; border-radius: 10px; aspect-ratio: 1 / 1;
        }
        .space {
            background-color: #f0f8ff; border: 1px solid #cbd5e0; position: relative; display: flex;
            flex-direction: column; justify-content: space-between; align-items: center;
            padding: 2px; font-size: 10px; text-align: center; overflow: hidden; cursor: pointer;
        }
        .space .space-name { flex-grow: 1; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .space .price { font-size: 9px; }
        .color-bar { width: 100%; height: 20%; flex-shrink: 0; }
        #space-0 { grid-area: 11 / 11 / 12 / 12; } #space-1 { grid-area: 11 / 10 / 12 / 11; }
        #space-2 { grid-area: 11 / 9 / 12 / 10; } #space-3 { grid-area: 11 / 8 / 12 / 9; }
        #space-4 { grid-area: 11 / 7 / 12 / 8; } #space-5 { grid-area: 11 / 6 / 12 / 7; }
        #space-6 { grid-area: 11 / 5 / 12 / 6; } #space-7 { grid-area: 11 / 4 / 12 / 5; }
        #space-8 { grid-area: 11 / 3 / 12 / 4; } #space-9 { grid-area: 11 / 2 / 12 / 3; }
        #space-10 { grid-area: 11 / 1 / 12 / 2; } #space-11 { grid-area: 10 / 1 / 11 / 2; }
        #space-12 { grid-area: 9 / 1 / 10 / 2; } #space-13 { grid-area: 8 / 1 / 9 / 2; }
        #space-14 { grid-area: 7 / 1 / 8 / 2; } #space-15 { grid-area: 6 / 1 / 7 / 2; }
        #space-16 { grid-area: 5 / 1 / 6 / 2; } #space-17 { grid-area: 4 / 1 / 5 / 2; }
        #space-18 { grid-area: 3 / 1 / 4 / 2; } #space-19 { grid-area: 2 / 1 / 3 / 2; }
        #space-20 { grid-area: 1 / 1 / 2 / 2; } #space-21 { grid-area: 1 / 2 / 2 / 3; }
        #space-22 { grid-area: 1 / 3 / 2 / 4; } #space-23 { grid-area: 1 / 4 / 2 / 5; }
        #space-24 { grid-area: 1 / 5 / 2 / 6; } #space-25 { grid-area: 1 / 6 / 2 / 7; }
        #space-26 { grid-area: 1 / 7 / 2 / 8; } #space-27 { grid-area: 1 / 8 / 2 / 9; }
        #space-28 { grid-area: 1 / 9 / 2 / 10; } #space-29 { grid-area: 1 / 10 / 2 / 11; }
        #space-30 { grid-area: 1 / 11 / 2 / 12; } #space-31 { grid-area: 2 / 11 / 3 / 12; }
        #space-32 { grid-area: 3 / 11 / 4 / 12; } #space-33 { grid-area: 4 / 11 / 5 / 12; }
        #space-34 { grid-area: 5 / 11 / 6 / 12; } #space-35 { grid-area: 6 / 11 / 7 / 12; }
        #space-36 { grid-area: 7 / 11 / 8 / 12; } #space-37 { grid-area: 8 / 11 / 9 / 12; }
        #space-38 { grid-area: 9 / 11 / 10 / 12; } #space-39 { grid-area: 10 / 11 / 11 / 12; }
        #board-center { grid-area: 2 / 2 / 11 / 11; background-color: #cde8d5; display: flex; justify-content: center; align-items: center; font-size: 2rem; font-weight: bold; color: #2f4f4f; border-radius: 5px;}
        .player-token { position: absolute; width: 20px; height: 20px; border: 2px solid white; border-radius: 50%; z-index: 10; transition: all 0.5s ease-in-out; box-shadow: 0 0 5px black; }
        .owned-indicator { position: absolute; bottom: 2px; right: 2px; width: 15px; height: 15px; border-radius: 50%; border: 1px solid white; box-shadow: 0 0 3px black; }
        .house-indicator { position: absolute; top: 0px; left: 0px; width: 100%; display: flex; justify-content: center; gap: 1px; }
        .house-icon { width: 10px; height: 10px; background-color: green; border: 1px solid white; }
        .hotel-icon { width: 15px; height: 15px; background-color: red; border: 1px solid white; font-size: 10px; color: white; text-align: center; font-weight: bold; }
        .modal { transition: opacity 0.3s ease; }
        .trade-property-list { max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; border-radius: 5px; }
        .trade-property-list label { display: block; margin-bottom: 5px; cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center p-4">

    <h1 class="text-4xl font-extrabold mb-4 text-gray-700">AIäº¤æ¸‰ãƒ¢ãƒãƒãƒªãƒ¼</h1>

    <div class="game-layout w-full max-w-screen-2xl">
        <div id="board" class="board"><div id="board-center">æ—¥æœ¬å‘¨éŠ</div></div>
        <div class="info-panel flex-grow w-full xl:max-w-md bg-white p-4 rounded-lg shadow-lg">
            <div id="players-info-container" class="mb-4">
                <h2 class="text-2xl font-bold border-b-2 pb-2 mb-2">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±</h2>
            </div>
            <div class="action-area bg-gray-100 p-4 rounded-lg shadow-inner">
                <h3 id="turn-indicator" class="text-xl font-bold text-center mb-4">ã‚ãªãŸã®ç•ªã§ã™</h3>
                <div id="action-panel" class="mb-4 text-center hidden">
                    <h4 id="action-title" class="font-bold"></h4><p id="action-text" class="my-2"></p>
                    <div id="action-buttons">
                        <button id="action-buy-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">è³¼å…¥</button>
                        <button id="action-pass-btn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">ã‚„ã‚ã‚‹</button>
                    </div>
                </div>
                <div id="dice-area" class="text-center">
                    <div class="flex justify-center gap-4 mb-2">
                        <div id="dice1" class="w-12 h-12 bg-white rounded-lg flex items-center justify-center text-2xl font-bold shadow-lg">?</div>
                        <div id="dice2" class="w-12 h-12 bg-white rounded-lg flex items-center justify-center text-2xl font-bold shadow-lg">?</div>
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button id="roll-dice-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-xl w-full">ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹</button>
                        <button id="manage-assets-btn" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-xl w-full">è³‡ç”£ç®¡ç†</button>
                    </div>
                </div>
            </div>
            <div id="log-area" class="w-full mt-4">
                <h3 class="font-bold text-center">ã‚²ãƒ¼ãƒ ãƒ­ã‚°</h3>
                <div id="log-messages" class="h-48 overflow-y-auto text-sm p-2 bg-gray-100 rounded shadow-inner"></div>
            </div>
        </div>
    </div>
    
    <div id="property-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full"><div id="modal-color-bar" class="w-full h-4 rounded-t-lg mb-4"></div><h3 id="modal-property-name" class="text-3xl font-bold mb-2 text-center"></h3><div id="modal-property-info" class="text-lg space-y-2"></div><button id="modal-close-btn" class="mt-6 w-full bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">é–‰ã˜ã‚‹</button></div>
    </div>
    
    <div id="manage-assets-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-lg w-full">
            <h3 class="text-2xl font-bold mb-4">è³‡ç”£ç®¡ç† (å»ºç¯‰)</h3>
            <div id="asset-groups-container" class="max-h-96 overflow-y-auto space-y-4"></div>
            <button id="manage-assets-close-btn" class="mt-6 w-full bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="trade-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-2xl w-full">
            <h3 id="trade-modal-title" class="text-2xl font-bold mb-4">äº¤æ¸‰</h3>
            <div id="trade-cpu-response" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 hidden" role="alert"></div>
            <div class="grid grid-cols-2 gap-6">
                <div><h4 class="font-bold text-lg mb-2" id="trade-your-offer-title">ã‚ãªãŸã®æç¤º</h4><div class="trade-property-list bg-gray-50" id="trade-your-properties"></div><div class="mt-2">ç¾é‡‘: Â¥ <input type="number" id="trade-your-money" class="w-32 border rounded p-1" value="0" min="0"></div></div>
                <div><h4 class="font-bold text-lg mb-2" id="trade-their-offer-title">ç›¸æ‰‹ã®æç¤º</h4><div class="trade-property-list bg-gray-50" id="trade-their-properties"></div><div class="mt-2">ç¾é‡‘: Â¥ <input type="number" id="trade-their-money" class="w-32 border rounded p-1" value="0" min="0"></div></div>
            </div>
            <div class="mt-4"><label for="trade-message" class="font-bold">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</label><textarea id="trade-message" class="w-full border rounded p-2 mt-1" placeholder="CPUã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea></div>
            <div class="mt-6 flex justify-end gap-4"><button id="trade-cancel-btn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">ã‚„ã‚ã‚‹</button><button id="trade-propose-btn" class="bg-green-600 hover:bg-green-800 text-white font-bold py-2 px-4 rounded">ææ¡ˆã™ã‚‹</button></div>
        </div>
    </div>
    
    <!-- CPU Offer Modal -->
    <div id="cpu-offer-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-lg w-full">
            <h3 id="cpu-offer-title" class="text-2xl font-bold mb-4">äº¤æ¸‰ã®ææ¡ˆ</h3>
            <p id="cpu-offer-text" class="mb-4"></p>
            <div class="grid grid-cols-2 gap-6 bg-gray-50 p-4 rounded-lg">
                <div><h4 class="font-bold text-lg mb-2">è¦æ±‚ã•ã‚Œã¦ã„ã‚‹è³‡ç”£</h4><div id="cpu-offer-request"></div></div>
                <div><h4 class="font-bold text-lg mb-2">æç¤ºã•ã‚Œã¦ã„ã‚‹è³‡ç”£</h4><div id="cpu-offer-proposal"></div></div>
            </div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="cpu-offer-reject-btn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">æ‹’å¦</button>
                <button id="cpu-offer-counter-btn" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">å†ææ¡ˆ</button>
                <button id="cpu-offer-accept-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">æ‰¿è«¾</button>
            </div>
        </div>
    </div>


    <script>
        // --- Game Data ---
        const boardData = [ { name: 'GO', type: 'go' }, { name: 'æ²–ç¸„', price: 6000, rentLevels: [200, 1000, 3000, 9000, 16000, 25000], color: '#a52a2a', houseCost: 5000 }, { name: 'ãƒãƒ£ãƒ³ã‚¹', type: 'chance' }, { name: 'ç¦å²¡', price: 6000, rentLevels: [400, 2000, 6000, 18000, 32000, 45000], color: '#a52a2a', houseCost: 5000 }, { name: 'æ‰€å¾—ç¨', type: 'tax', amount: 20000 }, { name: 'é‰„é“:å—', price: 20000, rent: 2500, type: 'railroad' }, { name: 'å¤§é˜ª', price: 10000, rentLevels: [600, 3000, 9000, 27000, 40000, 55000], color: '#add8e6', houseCost: 5000 }, { name: 'ãƒãƒ£ãƒ³ã‚¹', type: 'chance' }, { name: 'äº¬éƒ½', price: 10000, rentLevels: [600, 3000, 9000, 27000, 40000, 55000], color: '#add8e6', houseCost: 5000 }, { name: 'åå¤å±‹', price: 12000, rentLevels: [800, 4000, 10000, 30000, 45000, 60000], color: '#add8e6', houseCost: 5000 }, { name: 'åˆ‘å‹™æ‰€', type: 'jail' }, { name: 'é™å²¡', price: 14000, rentLevels: [1000, 5000, 15000, 45000, 62500, 75000], color: '#d8bfd8', houseCost: 10000 }, { name: 'é›»åŠ›ä¼šç¤¾', price: 15000, type: 'utility' }, { name: 'æ¨ªæµœ', price: 14000, rentLevels: [1000, 5000, 15000, 45000, 62500, 75000], color: '#d8bfd8', houseCost: 10000 }, { name: 'åƒè‘‰', price: 16000, rentLevels: [1200, 6000, 18000, 50000, 70000, 90000], color: '#d8bfd8', houseCost: 10000 }, { name: 'é‰„é“:è¥¿', price: 20000, rent: 2500, type: 'railroad' }, { name: 'åŸ¼ç‰', price: 18000, rentLevels: [1400, 7000, 20000, 55000, 75000, 95000], color: '#ffa500', houseCost: 10000 }, { name: 'ãƒãƒ£ãƒ³ã‚¹', type: 'chance' }, { name: 'ç¥å¥ˆå·', price: 18000, rentLevels: [1400, 7000, 20000, 55000, 75000, 95000], color: '#ffa500', houseCost: 10000 }, { name: 'æ±äº¬', price: 20000, rentLevels: [1600, 8000, 22000, 60000, 80000, 100000], color: '#ffa500', houseCost: 10000 }, { name: 'é§è»Šå ´', type: 'parking' }, { name: 'æ–°æ½Ÿ', price: 22000, rentLevels: [1800, 9000, 25000, 70000, 87500, 105000], color: '#ff0000', houseCost: 15000 }, { name: 'ãƒãƒ£ãƒ³ã‚¹', type: 'chance' }, { name: 'ä»™å°', price: 22000, rentLevels: [1800, 9000, 25000, 70000, 87500, 105000], color: '#ff0000', houseCost: 15000 }, { name: 'é’æ£®', price: 24000, rentLevels: [2000, 10000, 30000, 75000, 92500, 110000], color: '#ff0000', houseCost: 15000 }, { name: 'é‰„é“:åŒ—', price: 20000, rent: 2500, type: 'railroad' }, { name: 'ç§‹ç”°', price: 26000, rentLevels: [2200, 11000, 33000, 80000, 97500, 115000], color: '#ffff00', houseCost: 15000 }, { name: 'å²©æ‰‹', price: 26000, rentLevels: [2200, 11000, 33000, 80000, 97500, 115000], color: '#ffff00', houseCost: 15000 }, { name: 'æ°´é“ä¼šç¤¾', price: 15000, type: 'utility' }, { name: 'æœ­å¹Œ', price: 28000, rentLevels: [2400, 12000, 36000, 85000, 102500, 120000], color: '#ffff00', houseCost: 15000 }, { name: 'åˆ‘å‹™æ‰€ã¸è¡Œã‘', type: 'go_to_jail' }, { name: 'å±±æ¢¨', price: 30000, rentLevels: [2600, 13000, 39000, 90000, 110000, 127500], color: '#008000', houseCost: 20000 }, { name: 'é•·é‡', price: 30000, rentLevels: [2600, 13000, 39000, 90000, 110000, 127500], color: '#008000', houseCost: 20000 }, { name: 'ãƒãƒ£ãƒ³ã‚¹', type: 'chance' }, { name: 'éŠ€åº§', price: 32000, rentLevels: [2800, 15000, 45000, 100000, 120000, 140000], color: '#008000', houseCost: 20000 }, { name: 'é‰„é“:æ±', price: 20000, rent: 2500, type: 'railroad' }, { name: 'ãƒãƒ£ãƒ³ã‚¹', type: 'chance' }, { name: 'æ¸‹è°·', price: 35000, rentLevels: [3500, 17500, 50000, 110000, 130000, 150000], color: '#0000ff', houseCost: 20000 }, { name: 'ç‰©å“ç¨', type: 'tax', amount: 10000 }, { name: 'æ–°å®¿', price: 40000, rentLevels: [5000, 20000, 60000, 140000, 170000, 200000], color: '#0000ff', houseCost: 20000 } ];
        const chanceCards = [ { text: "éŠ€è¡Œã‹ã‚‰é…å½“é‡‘ Â¥5000 ã‚’å—ã‘å–ã‚‹ã€‚", action: (p) => { p.money += 5000; addLog(`${p.name} ã¯é…å½“é‡‘ Â¥5,000 ã‚’å—ã‘å–ã£ãŸã€‚`); } }, { text: "GOãƒã‚¹ã«é€²ã‚€ã€‚", action: (p, allPlayers) => { moveTo(p, 0, true); handleLanding(p, allPlayers); } }, { text: "ä¿®ç¹•è²»ã¨ã—ã¦ Â¥3000 æ”¯æ‰•ã†ã€‚", action: (p) => { p.money -= 3000; addLog(`${p.name} ã¯ä¿®ç¹•è²» Â¥3,000 ã‚’æ”¯æ‰•ã£ãŸã€‚`); } }, { text: "ä¸€ç•ªè¿‘ã„é‰„é“ã¾ã§é€²ã‚€ã€‚", action: (p, allPlayers) => advanceToNearest(p, 'railroad', allPlayers) }, { text: "åˆ‘å‹™æ‰€ã‹ã‚‰é‡ˆæ”¾ã•ã‚Œã‚‹ã‚«ãƒ¼ãƒ‰ã€‚", action: (p) => { p.getOutOfJailFree = true; addLog(`${p.name} ã¯ã€Œåˆ‘å‹™æ‰€ã‹ã‚‰é‡ˆæ”¾ã€ã‚«ãƒ¼ãƒ‰ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼`);} }, { text: "3ãƒã‚¹æˆ»ã‚‹ã€‚", action: (p, allPlayers) => { moveTo(p, (p.position - 3 + 40) % 40, false); handleLanding(p, allPlayers); } }, ];
        let players = []; let currentPlayerIndex = 0; let isGameOver = false; const NUM_PLAYERS = 3; let tradePartnerId = null; let activeCpuOffer = null; let isCounteringCpuOffer = false;
        const DOM = {}; // Centralized DOM elements

        function cacheDomElements() {
            const ids = ['board', 'players-info-container', 'roll-dice-btn', 'dice1', 'dice2', 'log-messages', 'turn-indicator', 'action-panel', 'action-title', 'action-text', 'action-buy-btn', 'action-pass-btn', 'property-modal', 'modal-color-bar', 'modal-property-name', 'modal-property-info', 'modal-close-btn', 'trade-modal', 'trade-modal-title', 'trade-cpu-response', 'trade-your-properties', 'trade-their-properties', 'trade-your-money', 'trade-their-money', 'trade-message', 'trade-cancel-btn', 'trade-propose-btn', 'manage-assets-btn', 'manage-assets-modal', 'asset-groups-container', 'manage-assets-close-btn', 'cpu-offer-modal', 'cpu-offer-title', 'cpu-offer-text', 'cpu-offer-request', 'cpu-offer-proposal', 'cpu-offer-reject-btn', 'cpu-offer-counter-btn', 'cpu-offer-accept-btn'];
            ids.forEach(id => DOM[id.replace(/-/g, '')] = document.getElementById(id));
        }

        // --- Game Logic ---
        function initGame() {
            cacheDomElements();
            boardData.forEach(space => { if (space.price) { space.owner = -1; space.houses = 0; }});
            drawBoard();
            players = [];
            players.push({ id: 0, name: 'ã‚ãªãŸ', type: 'human', money: 150000, position: 0, properties: [], inJail: false, jailTurns: 0, getOutOfJailFree: false, tokenElement: null, color: '#ef4444' });
            players.push({ id: 1, name: 'CPU 1', type: 'cpu', money: 150000, position: 0, properties: [], inJail: false, jailTurns: 0, getOutOfJailFree: false, tokenElement: null, color: '#3b82f6' });
            players.push({ id: 2, name: 'CPU 2', type: 'cpu', money: 150000, position: 0, properties: [], inJail: false, jailTurns: 0, getOutOfJailFree: false, tokenElement: null, color: '#22c55e' });
            players.forEach(p => { createPlayerToken(p); drawPlayerInfo(p); });
            addEventListeners();
            addLog("ã‚ˆã†ã“ãï¼AIäº¤æ¸‰ãƒ¢ãƒãƒãƒªãƒ¼ã¸ï¼");
            startTurn();
        }
        
        function addEventListeners() {
            DOM.modalclosebtn.addEventListener('click', () => DOM.propertymodal.classList.add('hidden'));
            DOM.tradecancelbtn.addEventListener('click', handleTradeCancel);
            DOM.tradeproposebtn.addEventListener('click', handleTradeProposal);
            DOM.rolldicebtn.addEventListener('click', () => { const p = players[currentPlayerIndex]; if(p.type === 'human' && !DOM.rolldicebtn.disabled) rollDiceAndMove(p); });
            DOM.manageassetsbtn.addEventListener('click', openManageAssetsModal);
            DOM.manageassetsclosebtn.addEventListener('click', () => DOM.manageassetsmodal.classList.add('hidden'));
            DOM.cpuofferacceptbtn.addEventListener('click', handleCpuOfferAccept);
            DOM.cpuofferrejectbtn.addEventListener('click', handleCpuOfferReject);
            DOM.cpuoffercounterbtn.addEventListener('click', handleCpuOfferCounter);
        }

        function drawBoard() {
            boardData.forEach((spaceData, i) => {
                const spaceEl = document.createElement('div'); spaceEl.id = `space-${i}`; spaceEl.className = 'space';
                let content = `<div class="space-name">${spaceData.name}</div>`;
                if(spaceData.color) content = `<div class="color-bar" style="background-color:${spaceData.color};"></div>` + content;
                if (spaceData.price) content += `<div class="price">Â¥${spaceData.price.toLocaleString()}</div>`;
                if (spaceData.type === 'tax') content += `<div class="price">æ”¯æ‰•ã„ Â¥${spaceData.amount.toLocaleString()}</div>`;
                spaceEl.innerHTML = content; spaceEl.addEventListener('click', () => showPropertyModal(i)); DOM.board.appendChild(spaceEl);
            });
        }
        function createPlayerToken(player) {
            player.tokenElement = document.createElement('div'); player.tokenElement.className = 'player-token';
            player.tokenElement.style.backgroundColor = player.color;
            player.tokenElement.style.transform = `translate(${-50 + player.id * 10}%, -50%)`;
            document.getElementById('space-0').appendChild(player.tokenElement);
        }
        function drawPlayerInfo(player) {
            let container = document.getElementById(`player-info-${player.id}`);
            if (!container) { container = document.createElement('div'); container.id = `player-info-${player.id}`; container.className = 'p-2 rounded-lg mb-2'; DOM.playersinfocontainer.appendChild(container); }
            container.style.border = `2px solid ${player.color}`;
            const propertiesHTML = player.properties.map(p_idx => `<span class="inline-block rounded px-1 text-xs mr-1 mb-1" style="background-color:${boardData[p_idx].color || '#ccc'}">${boardData[p_idx].name}</span>`).join('') || 'ãªã—';
            const jailCardHTML = player.getOutOfJailFree ? `<div class="font-bold text-sm text-yellow-600">Jail Free ã‚«ãƒ¼ãƒ‰æœ‰ã‚Š</div>` : '';
            const tradeButtonHTML = player.type === 'cpu' ? `<button class="trade-btn text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-700" data-playerid="${player.id}">äº¤æ¸‰</button>` : '';
            container.innerHTML = `<div class="flex justify-between items-start"><h3 class="font-bold text-lg" style="color:${player.color}">${player.name}</h3><div class="flex items-center gap-2">${jailCardHTML}${tradeButtonHTML}</div></div><p>æ‰€æŒé‡‘: <span class="font-bold">Â¥${player.money.toLocaleString()}</span></p><div class="mt-1">${propertiesHTML}</div>`;
            container.querySelectorAll('.trade-btn').forEach(btn => btn.addEventListener('click', (e) => openTradeModal(e.target.dataset.playerid)));
        }
        function addLog(message) { const msgEl = document.createElement('p'); msgEl.innerHTML = message; DOM.logmessages.prepend(msgEl); }
        function updateUI() {
            players.forEach(drawPlayerInfo);
            boardData.forEach((space, i) => {
                const spaceEl = document.getElementById(`space-${i}`);
                let ownerIndicator = spaceEl.querySelector('.owned-indicator');
                if (space.owner >= 0) {
                    if (!ownerIndicator) { ownerIndicator = document.createElement('div'); ownerIndicator.className = 'owned-indicator'; spaceEl.appendChild(ownerIndicator); }
                    ownerIndicator.style.backgroundColor = players[space.owner].color;
                } else if (ownerIndicator) { ownerIndicator.remove(); }
                
                let houseIndicator = spaceEl.querySelector('.house-indicator');
                if (space.houses > 0) {
                    if (!houseIndicator) { houseIndicator = document.createElement('div'); houseIndicator.className = 'house-indicator'; spaceEl.prepend(houseIndicator); }
                    houseIndicator.innerHTML = '';
                    if (space.houses === 5) { houseIndicator.innerHTML = '<div class="hotel-icon">H</div>'; }
                    else { for(let i=0; i < space.houses; i++) houseIndicator.innerHTML += '<div class="house-icon"></div>'; }
                } else if (houseIndicator) { houseIndicator.remove(); }
            });
            checkGameOver();
        }
        function movePlayerToken(player) { document.getElementById(`space-${player.position}`).appendChild(player.tokenElement); }
        function startTurn() {
            if (isGameOver) return;
            const currentPlayer = players[currentPlayerIndex];
            DOM.turnindicator.textContent = `${currentPlayer.name} ã®ç•ªã§ã™`; DOM.turnindicator.style.color = currentPlayer.color;
            DOM.actionpanel.classList.add('hidden');
            if (currentPlayer.money < 0) { addLog(`<span style="color:${currentPlayer.color}; font-weight: bold;">${currentPlayer.name}</span>ã¯ç ´ç”£ã—ã¾ã—ãŸã€‚`); nextTurn(); return; }
            if (currentPlayer.type === 'human') { DOM.rolldicebtn.disabled = false; DOM.manageassetsbtn.disabled = false; }
            else { DOM.rolldicebtn.disabled = true; DOM.manageassetsbtn.disabled = true; setTimeout(() => cpuTurn(currentPlayer), 500); }
        }
        function nextTurn() { currentPlayerIndex = (currentPlayerIndex + 1) % NUM_PLAYERS; startTurn(); }
        
        async function cpuTurn(player) {
            if (player.money < 0) { nextTurn(); return; }
            const tradeAction = await cpuCheckForTrade(player);
            if (tradeAction.shouldTrade) {
                if (tradeAction.targetPlayer.type === 'human') {
                    presentCpuOfferToPlayer(player, tradeAction.targetPlayer, tradeAction.offer, tradeAction.request);
                    return; // Pause turn, wait for human response
                } else {
                    handleCpuToCpuTrade(player, tradeAction.targetPlayer, tradeAction.offer, tradeAction.request);
                    setTimeout(() => { addLog(`ğŸ¤– ${player.name} ãŒã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚Šã¾ã™...`); rollDiceAndMove(player); }, 1000); // Continue turn after trade attempt
                }
            } else {
                addLog(`ğŸ¤– ${player.name} ãŒã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚Šã¾ã™...`);
                rollDiceAndMove(player);
            }
        }

        function rollDiceAndMove(player) {
            DOM.rolldicebtn.disabled = true; DOM.manageassetsbtn.disabled = true;
            const d1 = Math.floor(Math.random() * 6) + 1, d2 = Math.floor(Math.random() * 6) + 1;
            DOM.dice1.textContent = d1; DOM.dice2.textContent = d2; const totalRoll = d1 + d2;
            addLog(`${player.name} ã¯ ${totalRoll} é€²ã¿ã¾ã™ã€‚`); moveTo(player, (player.position + totalRoll) % 40, true);
            setTimeout(() => handleLanding(player, players), 600);
        }
        function moveTo(player, newPosition, passedGoCheck) {
            const oldPosition = player.position; player.position = newPosition;
            if (passedGoCheck && player.position < oldPosition) { addLog(`${player.name} ã¯GOã‚’é€šéã—ã€Â¥20,000 ã‚’å—ã‘å–ã£ãŸï¼`); player.money += 20000; }
            movePlayerToken(player); updateUI();
        }
        function handleLanding(player, allPlayers) {
            const space = boardData[player.position]; addLog(`${player.name} ã¯ <strong>${space.name}</strong> ã«æ­¢ã¾ã‚Šã¾ã—ãŸã€‚`);
            switch (space.type) {
                case 'railroad': case 'utility': case undefined:
                    if (space.owner === -1) promptToBuy(player, space);
                    else if (space.owner !== player.id) { payRent(player, space, allPlayers[space.owner]); setTimeout(nextTurn, 100); }
                    else { setTimeout(nextTurn, 100); }
                    break;
                case 'chance': drawChanceCard(player, allPlayers); break;
                case 'tax': player.money -= space.amount; addLog(`${player.name} ã¯ç¨é‡‘ Â¥${space.amount.toLocaleString()} ã‚’æ”¯æ‰•ã„ã¾ã™ã€‚`); updateUI(); setTimeout(nextTurn, 100); break;
                case 'go_to_jail': goToJail(player); setTimeout(nextTurn, 100); break;
                default: setTimeout(nextTurn, 100); break;
            }
            updateUI();
        }
        function promptToBuy(player, space) {
            if (player.money < space.price) { addLog(`${player.name} ã¯ãŠé‡‘ãŒè¶³ã‚Šãš ${space.name} ã‚’è²·ãˆã¾ã›ã‚“ã€‚`); setTimeout(nextTurn, 100); return; }
            if (player.type === 'human') {
                DOM.actionpanel.classList.remove('hidden'); DOM.actiontitle.textContent = `ã€Œ${space.name}ã€ã‚’è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ`; DOM.actiontext.textContent = `ä¾¡æ ¼: Â¥${space.price.toLocaleString()}`;
                DOM.actionbuybtn.onclick = () => { buyProperty(player, space); DOM.actionpanel.classList.add('hidden'); setTimeout(nextTurn, 100); };
                DOM.actionpassbtn.onclick = () => { addLog(`${player.name} ã¯è³¼å…¥ã‚’è¦‹é€ã‚Šã¾ã—ãŸã€‚`); DOM.actionpanel.classList.add('hidden'); setTimeout(nextTurn, 100); };
            } else { setTimeout(() => { if (player.money > space.price * 3) buyProperty(player, space); else addLog(`ğŸ¤– ${player.name} ã¯ ${space.name} ã®è³¼å…¥ã‚’è¦‹é€ã‚Šã¾ã—ãŸã€‚`); setTimeout(nextTurn, 100); }, 1000); }
        }
        function buyProperty(player, space) { player.money -= space.price; player.properties.push(boardData.indexOf(space)); space.owner = player.id; addLog(`<span style="color:${player.color}">${player.name}</span> ãŒ <strong>${space.name}</strong> ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼`); updateUI(); }
        function payRent(payer, space, owner) {
            let rent;
            if (space.houses > 0) rent = space.rentLevels[space.houses];
            else if (space.type === 'utility') rent = (parseInt(DOM.dice1.textContent) + parseInt(DOM.dice2.textContent)) * (owner.properties.filter(p_idx => boardData[p_idx].type === 'utility').length === 1 ? 400 : 1000);
            else if (space.type === 'railroad') rent = 2500 * Math.pow(2, owner.properties.filter(p_idx => boardData[p_idx].type === 'railroad').length - 1);
            else rent = space.rentLevels[0];
            payer.money -= rent; owner.money += rent; addLog(`<span style="color:${payer.color}">${payer.name}</span> ã¯ <span style="color:${owner.color}">${owner.name}</span> ã«ãƒ¬ãƒ³ã‚¿ãƒ«æ–™ Â¥${rent.toLocaleString()} ã‚’æ”¯æ‰•ã£ãŸã€‚`); updateUI();
        }
        function drawChanceCard(player, allPlayers) {
            const card = chanceCards[Math.floor(Math.random() * chanceCards.length)]; addLog(`<strong>ãƒãƒ£ãƒ³ã‚¹ï¼</strong> ${player.name}: ${card.text}`);
            card.action(player, allPlayers); updateUI();
            if (!card.text.includes('é€²ã‚€') && !card.text.includes('æˆ»ã‚‹')) setTimeout(nextTurn, 100);
        }
        function goToJail(player) { addLog(`${player.name} ã¯åˆ‘å‹™æ‰€ã¸ï¼`); player.position = 10; player.inJail = true; player.jailTurns = 0; movePlayerToken(player); }
        function advanceToNearest(player, type, allPlayers) {
            let pos = player.position;
            while (true) {
                pos = (pos + 1) % 40;
                if (boardData[pos].type === type) { moveTo(player, pos, true); addLog(`${player.name} ã¯ä¸€ç•ªè¿‘ã„ ${boardData[pos].name} ã«é€²ã¿ã¾ã—ãŸã€‚`); handleLanding(player, allPlayers); return; }
            }
        }
        function showPropertyModal(spaceIndex) {
            const space = boardData[spaceIndex]; DOM.modalpropertyname.textContent = space.name; DOM.modalcolorbar.style.backgroundColor = space.color || 'transparent';
            let infoHTML = '';
            if (space.price) {
                const owner = space.owner >= 0 ? players[space.owner] : null;
                infoHTML += `<p><strong>ä¾¡æ ¼:</strong> Â¥${space.price.toLocaleString()}</p>`;
                infoHTML += owner ? `<p><strong>æ‰€æœ‰è€…:</strong> <span style="color:${owner.color}; font-weight: bold;">${owner.name}</span></p>` : `<p><strong>æ‰€æœ‰è€…:</strong> ãªã—</p>`;
                if (space.rentLevels) { infoHTML += `<p><strong>ãƒ¬ãƒ³ã‚¿ãƒ«æ–™:</strong> Â¥${space.rentLevels[space.houses].toLocaleString()}</p>`; infoHTML += `<p class="text-xs"> (å®¶1: Â¥${space.rentLevels[1]}, 2: Â¥${space.rentLevels[2]}, 3: Â¥${space.rentLevels[3]}, 4: Â¥${space.rentLevels[4]}, H: Â¥${space.rentLevels[5]})</p>`; infoHTML += `<p><strong>å»ºç¯‰ã‚³ã‚¹ãƒˆ:</strong> Â¥${space.houseCost.toLocaleString()}</p>`; }
                else if (space.type === 'railroad') infoHTML += `<p><strong>ãƒ¬ãƒ³ã‚¿ãƒ«æ–™:</strong> æ‰€æœ‰æ•°ã«å¿œã˜ã¦å¤‰å‹•</p>`;
                else if (space.type === 'utility') infoHTML += `<p><strong>ãƒ¬ãƒ³ã‚¿ãƒ«æ–™:</strong> ã‚µã‚¤ã‚³ãƒ­ã®ç›®ã«å¿œã˜ã¦å¤‰å‹•</p>`;
            } else infoHTML += `<p>${space.type}ãƒã‚¹ã§ã™ã€‚</p>`;
            DOM.modalpropertyinfo.innerHTML = infoHTML; DOM.propertymodal.classList.remove('hidden');
        }
        function checkGameOver() {
            if (isGameOver) return;
            const activePlayers = players.filter(p => p.money >= 0);
            if (activePlayers.length <= 1) {
                isGameOver = true; const winner = activePlayers.length === 1 ? activePlayers[0] : null; let title, text;
                if (winner) { title = `${winner.name} ã®å‹åˆ©ï¼`; text = `${winner.name} ãŒæœ€å¾Œã®å‹è€…ã¨ãªã‚Šã¾ã—ãŸï¼`; DOM.turnindicator.style.color = winner.color; }
                else { title = "å¼•ãåˆ†ã‘ï¼"; text = "å‹è€…ãŒã„ã¾ã›ã‚“ã§ã—ãŸã€‚"; }
                DOM.turnindicator.textContent = title; DOM.rolldicebtn.disabled = true; DOM.actionpanel.classList.remove('hidden');
                DOM.actiontitle.textContent = "ã‚²ãƒ¼ãƒ çµ‚äº†ï¼"; DOM.actiontext.textContent = text; DOM.actionbuybtn.style.display = 'none';
                DOM.actionpassbtn.textContent = 'ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤'; DOM.actionpassbtn.onclick = () => window.location.reload();
            }
        }

        // --- Build Logic ---
        function openManageAssetsModal() {
            const player = players[0]; DOM.assetgroupscontainer.innerHTML = '';
            const groupedProperties = {};
            player.properties.forEach(p_idx => { const prop = boardData[p_idx]; if (!prop.color) return; if (!groupedProperties[prop.color]) groupedProperties[prop.color] = []; groupedProperties[prop.color].push(prop); });
            for(const color in groupedProperties) {
                const group = groupedProperties[color]; const allPropsOfColor = boardData.filter(p => p.color === color); const isMonopoly = group.length === allPropsOfColor.length;
                const groupDiv = document.createElement('div'); groupDiv.className = 'p-2 border rounded'; groupDiv.style.borderColor = color; let propertiesHTML = ''; let minHouses = 5;
                if (isMonopoly) { minHouses = Math.min(...group.map(p => p.houses)); }
                group.forEach(prop => {
                    const propIndex = boardData.indexOf(prop); let buildButton = '';
                    if (isMonopoly && prop.houses < 5 && prop.houses <= minHouses) {
                        const cost = prop.houseCost; const action = prop.houses < 4 ? 'å®¶ã‚’å»ºã¦ã‚‹' : 'ãƒ›ãƒ†ãƒ«ã‚’å»ºã¦ã‚‹';
                         if (player.money >= cost) { buildButton = `<button class="build-btn text-xs bg-green-500 text-white px-2 py-1 rounded" data-pidx="${propIndex}">+ ${action} (Â¥${cost})</button>`; }
                    }
                    propertiesHTML += `<div class="flex justify-between items-center p-1"><span>${prop.name} (å®¶: ${prop.houses === 5 ? 'H' : prop.houses})</span> ${buildButton}</div>`;
                });
                groupDiv.innerHTML = `<h4 class="font-bold" style="color:${color}">ç‹¬å çŠ¶æ…‹: ${isMonopoly ? 'ã¯ã„' : 'ã„ã„ãˆ'}</h4>${propertiesHTML}`; DOM.assetgroupscontainer.appendChild(groupDiv);
            }
            DOM.assetgroupscontainer.querySelectorAll('.build-btn').forEach(btn => btn.addEventListener('click', handleBuildHouse)); DOM.manageassetsmodal.classList.remove('hidden');
        }
        function handleBuildHouse(event) {
            const player = players[0]; const propIndex = parseInt(event.target.dataset.pidx); const prop = boardData[propIndex];
            if (player.money >= prop.houseCost && prop.houses < 5) {
                player.money -= prop.houseCost; prop.houses++; addLog(`${player.name}ãŒ${prop.name}ã«${prop.houses === 5 ? 'ãƒ›ãƒ†ãƒ«' : 'å®¶'}ã‚’å»ºã¦ã¾ã—ãŸã€‚`);
                openManageAssetsModal(); updateUI();
            } else { addLog('å»ºç¯‰è³‡é‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚'); }
        }
        
        // --- Trade Logic ---
        function openTradeModal(targetPlayerId) {
            tradePartnerId = parseInt(targetPlayerId); const player = players[0]; const partner = players[tradePartnerId];
            DOM.trademodaltitle.textContent = `${partner.name} ã¨ã®äº¤æ¸‰`; DOM.tradecpuresponse.classList.add('hidden'); DOM.trademessage.value = '';
            const populateList = (element, owner) => {
                element.innerHTML = ''; if (owner.properties.length === 0) { element.innerHTML = '<p class="text-gray-500">æ‰€æœ‰ç‰©ä»¶ãªã—</p>'; return; }
                owner.properties.forEach(p_idx => { const prop = boardData[p_idx]; element.innerHTML += `<label><input type="checkbox" data-pidx="${p_idx}" name="trade_prop_${owner.id}"> <span style="color:${prop.color || '#333'}">${prop.name}</span></label>`; });
            };
            populateList(DOM.tradeyourproperties, player); populateList(DOM.tradetheirproperties, partner);
            DOM.tradeyourmoney.value = 0; DOM.tradeyourmoney.max = player.money; DOM.tradetheirmoney.value = 0; DOM.tradetheirmoney.max = partner.money;
            DOM.trademodal.classList.remove('hidden');
        }
        async function handleTradeProposal() {
            DOM.tradeproposebtn.disabled = true; DOM.tradeproposebtn.textContent = 'AIãŒè€ƒæ…®ä¸­...'; DOM.tradecpuresponse.classList.add('hidden');
            const player = players[0]; const partner = players[tradePartnerId];
            const getSelectedProps = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => parseInt(cb.dataset.pidx));
            const yourOffer = { properties: getSelectedProps('trade_prop_0'), money: parseInt(DOM.tradeyourmoney.value) };
            const theirOffer = { properties: getSelectedProps(`trade_prop_${tradePartnerId}`), money: parseInt(DOM.tradetheirmoney.value) };
            try {
                const llmResponse = await getLlmNegotiationResponse(player, partner, yourOffer, theirOffer, DOM.trademessage.value);
                DOM.tradecpuresponse.innerHTML = `<p class="font-bold">${partner.name}ã®è¿”ç­”:</p><p>${llmResponse.response_text}</p>`; DOM.tradecpuresponse.classList.remove('hidden');
                if (llmResponse.decision === 'accept') { addLog(`äº¤æ¸‰æˆç«‹ï¼ ${partner.name}ã¯ææ¡ˆã‚’å—ã‘å…¥ã‚ŒãŸã€‚`); executeTrade(player, partner, yourOffer, theirOffer); DOM.trademodal.classList.add('hidden');
                } else if (llmResponse.decision === 'reject') addLog(`äº¤æ¸‰æ±ºè£‚ï¼ ${partner.name}ã¯ææ¡ˆã‚’æ‹’å¦ã—ãŸã€‚`);
                else if (llmResponse.decision === 'counter') addLog(`${partner.name}ãŒæ–°ãŸãªæ¡ä»¶ã‚’æç¤ºã—ã¦ããŸã€‚`);
            } catch (error) { console.error("LLM negotiation failed:", error); DOM.tradecpuresponse.textContent = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"; DOM.tradecpuresponse.classList.remove('hidden');
            } finally {
                DOM.tradeproposebtn.disabled = false; DOM.tradeproposebtn.textContent = 'ææ¡ˆã™ã‚‹';
                if (isCounteringCpuOffer) {
                    isCounteringCpuOffer = false;
                    DOM.trademodal.classList.add('hidden');
                    const cpu = players[currentPlayerIndex];
                    setTimeout(() => { addLog(`ğŸ¤– ${cpu.name} ãŒã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚Šã¾ã™...`); rollDiceAndMove(cpu); }, 1000);
                }
            }
        }
        function executeTrade(player, partner, playerOffer, partnerOffer) {
            player.money = player.money - playerOffer.money + partnerOffer.money; partner.money = partner.money + playerOffer.money - partnerOffer.money;
            player.properties = player.properties.filter(p => !playerOffer.properties.includes(p)); partner.properties = partner.properties.filter(p => !partnerOffer.properties.includes(p));
            player.properties.push(...partnerOffer.properties); partner.properties.push(...playerOffer.properties);
            playerOffer.properties.forEach(p_idx => boardData[p_idx].owner = partner.id); partnerOffer.properties.forEach(p_idx => boardData[p_idx].owner = player.id);
            updateUI();
        }
        async function getLlmNegotiationResponse(player, partner, playerOffer, partnerOffer, message) {
            console.log("Simulating LLM API Call for human->cpu trade...");
            const playerOfferValue = playerOffer.properties.reduce((sum, p_idx) => sum + boardData[p_idx].price, 0) + playerOffer.money;
            const partnerOfferValue = partnerOffer.properties.reduce((sum, p_idx) => sum + boardData[p_idx].price, 0) + partnerOffer.money;
            return new Promise(resolve => {
                setTimeout(() => {
                    if (playerOfferValue >= partnerOfferValue * 1.2) resolve({ decision: 'accept', response_text: 'ç´ æ™´ã‚‰ã—ã„ã”ææ¡ˆã§ã™ã­ï¼ãã®æ¡ä»¶ã€ãœã²å—ã‘å…¥ã‚Œã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚', });
                    else if (playerOfferValue >= partnerOfferValue * 0.8) resolve({ decision: 'counter', response_text: `ã†ãƒ¼ã‚“ã€æ‚ªããªã„ã§ã™ãŒã€å°‘ã—å³ã—ã„ã§ã™ã­ã€‚ã‚‚ã—ã€ã‚ãªãŸã‹ã‚‰ã‚ã¨${Math.floor((partnerOfferValue - playerOfferValue)*1.1)}å††ã„ãŸã ã‘ã‚Œã°è€ƒãˆã¾ã™ã‚ˆã€‚`, });
                    else resolve({ decision: 'reject', response_text: 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ãŒã€ãã®æ¡ä»¶ã§ã¯åˆ°åº•å—ã‘å…¥ã‚Œã‚‰ã‚Œã¾ã›ã‚“ã€‚ã‚‚ã£ã¨è‰¯ã„ææ¡ˆã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚', });
                }, 1500);
            });
        }
        
        // --- CPU-initiated Trade Logic ---
        async function cpuCheckForTrade(cpu) {
            for (const color of Object.keys(getColorGroups())) {
                const group = getColorGroups()[color];
                const myPropsInGroup = cpu.properties.filter(p_idx => boardData[p_idx].color === color);
                
                if (myPropsInGroup.length > 0 && myPropsInGroup.length === group.length - 1) { // CPU needs one more property for a monopoly
                    const neededPropIdx = group.find(p_idx => !myPropsInGroup.includes(p_idx));
                    const neededProp = boardData[neededPropIdx];
                    if (neededProp.owner < 0) continue; // Property is unowned
                    const targetPlayer = players[neededProp.owner];

                    if (targetPlayer && targetPlayer.id !== cpu.id) {
                        const offerValue = Math.floor(neededProp.price * 1.2); // Offer 20% more than face value
                        const offer = { properties: [], money: offerValue };
                        const request = { properties: [neededPropIdx], money: 0 };
                        
                        if (cpu.money > offerValue) {
                            return { shouldTrade: true, targetPlayer, offer, request };
                        }
                    }
                }
            }
            return { shouldTrade: false };
        }

        function handleCpuToCpuTrade(offeringCpu, targetCpu, offer, request) {
            const offerValue = offer.properties.reduce((s, p) => s + boardData[p].price, 0) + offer.money;
            const requestValue = request.properties.reduce((s, p) => s + boardData[p].price, 0) + request.money;

            addLog(`ğŸ¤– <span style="color:${offeringCpu.color};">${offeringCpu.name}</span> ãŒ <span style="color:${targetCpu.color};">${targetCpu.name}</span> ã«äº¤æ¸‰ã‚’æŒã¡ã‹ã‘ã¾ã—ãŸ...`);

            if (targetCpu.money < 0) {
                 addLog(`ã—ã‹ã—ã€<span style="color:${targetCpu.color};">${targetCpu.name}</span>ã¯ç ´ç”£ã—ã¦ã„ã‚‹ãŸã‚äº¤æ¸‰ã§ãã¾ã›ã‚“ã€‚`);
                 return;
            }

            if (offerValue > requestValue * 1.1) { // Target CPU accepts if offer is >10% better
                setTimeout(() => {
                    addLog(`äº¤æ¸‰æˆç«‹ï¼ <span style="color:${targetCpu.color};">${targetCpu.name}</span> ã¯ <span style="color:${offeringCpu.color};">${offeringCpu.name}</span> ã®ææ¡ˆã‚’å—ã‘å…¥ã‚Œã¾ã—ãŸã€‚`);
                    executeTrade(offeringCpu, targetCpu, offer, request);
                }, 1000);
            } else {
                setTimeout(() => {
                    addLog(`äº¤æ¸‰æ±ºè£‚ï¼ <span style="color:${targetCpu.color};">${targetCpu.name}</span> ã¯ <span style="color:${offeringCpu.color};">${offeringCpu.name}</span> ã®ææ¡ˆã‚’æ‹’å¦ã—ã¾ã—ãŸã€‚`);
                }, 1000);
            }
        }

        function presentCpuOfferToPlayer(cpu, player, offer, request) {
            activeCpuOffer = { cpu, player, offer, request };
            DOM.cpuoffertitle.textContent = `${cpu.name}ã‹ã‚‰ã®äº¤æ¸‰ææ¡ˆ`;
            DOM.cpuoffertext.textContent = `ã€Œ${boardData[request.properties[0]].name}ã€ã‚’ç‹¬å ã—ãŸã„ã‚ˆã†ã§ã™ã€‚ä»¥ä¸‹ã®æ¡ä»¶ã§äº¤æ›ã—ã¾ã›ã‚“ã‹ï¼Ÿ`;
            
            const formatAssets = (assets) => `<ul>${assets.properties.map(p=>`<li>${boardData[p].name}</li>`).join('')}</ul> <p>ç¾é‡‘: Â¥${assets.money.toLocaleString()}</p>`;
            DOM.cpuofferrequest.innerHTML = formatAssets(request);
            DOM.cpuofferproposal.innerHTML = formatAssets(offer);
            
            DOM.cpuoffermodal.classList.remove('hidden');
        }
        
        function resumeCpuTurn(cpu) {
             setTimeout(() => {
                addLog(`ğŸ¤– ${cpu.name} ãŒã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚Šã¾ã™...`);
                rollDiceAndMove(cpu);
            }, 1000);
        }

        function handleCpuOfferAccept() {
            if (!activeCpuOffer) return;
            const { cpu, player, offer, request } = activeCpuOffer;
            addLog(`äº¤æ¸‰æˆç«‹ï¼ ã‚ãªãŸã¯ ${cpu.name} ã®ææ¡ˆã‚’å—ã‘å…¥ã‚Œã¾ã—ãŸã€‚`);
            executeTrade(cpu, player, offer, request);
            DOM.cpuoffermodal.classList.add('hidden');
            const originalCpu = activeCpuOffer.cpu;
            activeCpuOffer = null;
            resumeCpuTurn(originalCpu);
        }

        function handleCpuOfferReject() {
            if (!activeCpuOffer) return;
            const { cpu } = activeCpuOffer;
            addLog(`äº¤æ¸‰æ±ºè£‚ï¼ ã‚ãªãŸã¯ ${cpu.name} ã®ææ¡ˆã‚’æ‹’å¦ã—ã¾ã—ãŸã€‚`);
            DOM.cpuoffermodal.classList.add('hidden');
            const originalCpu = activeCpuOffer.cpu;
            activeCpuOffer = null;
            resumeCpuTurn(originalCpu);
        }

        function handleCpuOfferCounter() {
            if (!activeCpuOffer) return;
            const { cpu } = activeCpuOffer;
            DOM.cpuoffermodal.classList.add('hidden');
            isCounteringCpuOffer = true;
            openTradeModal(cpu.id);
        }
        
        function handleTradeCancel() {
            DOM.trademodal.classList.add('hidden');
            if (isCounteringCpuOffer) {
                isCounteringCpuOffer = false;
                const cpu = players[currentPlayerIndex];
                addLog(`å†ææ¡ˆã‚’å–ã‚Šã‚„ã‚ã€${cpu.name}ã®ã‚¿ãƒ¼ãƒ³ã‚’ç¶šè¡Œã—ã¾ã™ã€‚`);
                resumeCpuTurn(cpu);
            }
        }
        
        function getColorGroups() {
            const groups = {};
            boardData.forEach((p, i) => {
                if (p.color) {
                    if (!groups[p.color]) groups[p.color] = [];
                    groups[p.color].push(i);
                }
            });
            return groups;
        }

        // --- Start Game ---
        window.onload = initGame;
    </script>
</body>
</html>
